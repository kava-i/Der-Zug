<!DOCTYPE html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
body {
    background: black;
    background-image: url('{{world}}/background.jpg');
    background-size: cover;
    height: 100vh;
    background-repeat: no-repeat;
    color: white;
}

.container {
  position: relative;
}

.setting-btn {
  position: absolute;
  width: 50%;
  height: 50px;
  z-index: 1;
  {% if appearance.text-box.width > 90 %}
    left: calc(100% - 5rem);
  {% endif %}

}

.content {
  position: relative;
  width: 100%;
  height: 100%;
  z-index: 0;
}

.input,.input:focus {
  position: fixed;
  {% if appearance.input-bar-settings.attached %}
    left: {{appearance.text-box.left}}%;
    width: calc({{appearance.text-box.width}}% + 2 * {{appearance.text-box.padding}});
    top: calc({{appearance.text-box.top}}% + {{appearance.text-box.height}}% + 1 * {{appearance.text-box.padding}});
  {% else %}
    left: {{appearance.input-bar.left}}%;
    width: {{appearance.input-bar.width}}%;
    top: calc(100% - 3rem - {{appearance.input-bar.bottom}}rem);
  {% endif %}
  color: green;
  height: {%- if appearance.input-bar-settings.topline -%}3rem{%- else -%}2.2rem{%- endif -%};
  overflow: hidden;
  background: black;
}

#input {
  border: None;
  color: #ff9800;
  background: black;
  width: calc(100% - 2rem);
}
input:focus{
  outline: none;
}

.output {
    margin: 0;
    padding: {{appearance.text-box.padding}};
    position: fixed;
    left: {{appearance.text-box.left}}%;
    top: {{appearance.text-box.top}}%;
    height: {{appearance.text-box.height}}%;
    overflow-y: auto;
    background-color: rgba(0,0,0,0.95);
    width: {{appearance.text-box.width}}%;
    font-size: small;
    color: #f8f9f9;
}

.spoken {
    padding-left: 2.5em;
    text-indent:-2.5em;
}

.spoken2 {
    padding-left: 2.5em;
    color: #bdc3c7;
}

hr {
  width: 100vw;
  color: #ba68c8;
}

.black{
    color: black;
}
.red {
    color:  #e74c3c;
}

.white {
    color:  #f8f9f9;
}

.whitedark {
    color: #bdc3c7;
}

.dark {
    color: #839192;
}

.green {
    color: #1e8449;
}

.yellow {
    color: yellow;
}

.blue {
    color: #2e86c1;
}

.orange {
    color: #ff9800;
}


</style>
<script>
var host = location.host.substr(0, location.host.indexOf(":"));
var socket = null
if (host == "localhost" || host == "127.0.0.1")
  socket = new WebSocket("ws://" + host + ":{{port}}");
else
  socket = new WebSocket("wss://" + host + ":{{port}}");


let clicked = false;
let aud = new Audio('{{world}}/{{ default(music, "piano") }}.mp3');

aud.addEventListener('ended', function() {
    this.currentTime = 0;
    this.play();
  }, false);


function playMusik() {
  if (clicked == false) {
    aud.play();
    document.getElementById("audio_toggle").innerHTML = "volume_up";
    clicked = true;
    document.getElementById("input").focus();
  }

  else {
    aud.pause();
    document.getElementById("audio_toggle").innerHTML = "volume_off";
    clicked = false;
    document.getElementById("input").focus();
  }
}

function onFullScreenChange() {
  var fullscreenElement =
    document.fullscreenElement ||
    document.mozFullScreenElement ||
    document.webkitFullscreenElement;
  if (fullscreenElement === undefined || fullscreenElement === null) {
    closeFullscreen(document.documentElement);
  }
}

let gPipelinedOutput = null;
let gPipelineNextEnter = false;
let listOfCommands = [];
let currentIter = -1;
function bdyonload() {
  document.addEventListener('fullscreenchange', onFullScreenChange, false);
  document.addEventListener('webkitfullscreenchange', onFullScreenChange, false);
  document.addEventListener('mozfullscreenchange', onFullScreenChange, false);


  printString("login/register (l/r):");
  document.getElementById("input").addEventListener("keydown",function(event) {
    if (event.key === "Enter") {
      if (gPipelineNextEnter) {
        gPipelineNextEnter = false;
        if (gPipelinedOutput!=null) {
            output.innerHTML = output.innerHTML.substr(0, output.innerHTML.lastIndexOf(
                  "Press Enter to continue"));
            console.log(gPipelinedOutput);
            printString(gPipelinedOutput);
        }
      }
      else {
        let st = document.getElementById("input").value;
        let k = st.toLowerCase();
        document.getElementById("input").value ="";
        if(k=="")
            printString('\x06'+". . ."+'\n');
        //else
        //    printString('\x06'+k+'\n');
        listOfCommands.push(k);
        socket.send(k);
        let val = document.getElementById("output");
        val.scrollTop = val.scrollHeight;
        currentIter = -1;
      }
    }
    if(listOfCommands.length==0)
      return;
    if(event.keyCode === 38) {
      currentIter--;
      if (currentIter<0)
        currentIter = listOfCommands.length-1;
      document.getElementById("input").value = listOfCommands[currentIter];
    }
    else if(event.keyCode === 40) {
      currentIter++;
      if(currentIter == listOfCommands.length)
      currentIter = 0;
      document.getElementById("input").value = listOfCommands[currentIter];
    }
  });
  document.getElementById("input").focus();
  socket.onmessage = function(event){console.log("Received: "+event.data);printString(event.data);};
}

function isspanret(isspan,colname) {
  if (isspan)
    return "</span><span class='"+colname+"'>";
  else
    return "<span class='"+colname+"'>";
}

async function changeAudio(new_audio) {
  var fadePoint = aud.currentTime+1;
  var fade = setInterval(function() {
    if (aud.currentTime >= fadePoint && aud.volume > 0.0) {
      aud.volume -= 0.1;
      console.log("Volume: ", aud.volume);
    }
    if (aud.volume <= 0.1) {
      aud.pause();
      aud = new Audio(new_audio);
      aud.addEventListener('ended', function() {
        this.currentTime = 0;
        this.play();
      }, false);
      aud.volume = 1;
      if (clicked) 
        aud.play();
      clearInterval(fade);
    }
  }, 100);
}

function parse_file(strin,x) {
  name = '';
  for (let i = x+1; i < strin.length; i++) {
    if (strin[i] == '\x07') {
      changeAudio("{{world}}/" + name + ".mp3");
	    return i+1;
	  }
    if (strin[i] == '\x0B') {
      document.body.style.backgroundImage = "url('{{world}}/" + name + ".jpg')";
	    return i+1;
	  }
	  else
	    name+=strin[i]
  }
}

function printString(theString)
{
    if (theString.indexOf("Logged in as") != -1) {
      document.getElementById("btn_play_music").click();
      openFullscreen(document.documentElement);
	    document.getElementById("output").innerHTML = "";
	    outpt.scrollTop = outpt.scrollHeight;
      return;
    }
    let out = "";
    let isspanopen = false;
    for(let i = 0; i < theString.length; i++)
    {
        if(theString[i] == '\n')
            out+="<br class='line'>";
        else if(theString[i] == '\x00')
            out+=isspanret(isspanopen,"black");
        else if(theString[i] == '\x01')
            out+=isspanret(isspanopen,"white");
        else if(theString[i] == '\x02')
            out+=isspanret(isspanopen,"red");
        else if(theString[i] == '\x03')
            out+=isspanret(isspanopen,"green");
        else if(theString[i] == '\x04')
            out+=isspanret(isspanopen,"yellow");
        else if(theString[i] == '\x05')
            out+=isspanret(isspanopen,"blue");
        else if(theString[i] == '\x08')
            out+=isspanret(isspanopen, "dark");
        else if(theString[i] == '\x06')
            out+=isspanret(isspanopen,"orange");
        else if(theString[i] == '\x09')
            out+=isspanret(isspanopen, "whitedark");
        else if(theString[i] == '\x07' || theString[i] == '\x0B')
            i=parse_file(theString,i);
        else if(theString[i] == '$')
        {
            out+="<br class='line'><span style='color:#f8f9f9'>Press Enter to continue...<span><br class='line'>";
            gPipelinedOutput = theString.substr(i+2);
            console.log(gPipelinedOutput);
            gPipelineNextEnter = true;
            break;
        }
        else
            out+=theString[i];
        if(theString[i] >= '\x01' && theString[i] <= '\x05')
            isspanopen = true;
    }
    if(isspanopen)
    {
        out+="</span>";
    }
	let outpt = document.getElementById("output");
  // TypeWriter(outpt, out, 0)
  outpt.innerHTML += out;
	outpt.scrollTop = outpt.scrollHeight;
}

function TypeWriter(output, text, i) {
  if (i < text.length) {
    var ch = text.charAt(i);
    if (ch === "<") {
      var endTagIndex = text.indexOf(">", i);
      if (endTagIndex > -1) {
        ch = text.slice(i, endTagIndex+1);
        i = endTagIndex;
      }
    }
    output.innerText += text[i];
    i++
    setTimeout(function() { TypeWriter(output, text, i); }, 20);
  }
  else {
    output.innerHTML == text;
  }
}

function openFullscreen(elem) {
  if (elem.requestFullscreen) {
    elem.requestFullscreen();
  } else if (elem.mozRequestFullScreen) { /* Firefox */
    elem.mozRequestFullScreen();
  } else if (elem.webkitRequestFullscreen) { /* Chrome, Safari and Opera */
    elem.webkitRequestFullscreen();
  } else if (elem.msRequestFullscreen) { /* IE/Edge */
    elem.msRequestFullscreen();
  }
  document.getElementById("btn_toggle_fullscreen").style.display = "none";
  document.getElementById("btn_play_music").style.display = "none";
  document.getElementById("input").focus();
}

function hasFullscreen(elem) {
    let hasfull = false;
    if (elem.requestFullscreen) {
	hasfull = true;
  } else if (elem.mozRequestFullScreen) { /* Firefox */
	hasfull = true;
  } else if (elem.webkitRequestFullscreen) { /* Chrome, Safari and Opera */
	hasfull = true;
  } else if (elem.msRequestFullscreen) { /* IE/Edge */
	hasfull = true;
  }
    return hasfull;
}

/* Close fullscreen */
function closeFullscreen(elem) {
  if (document.exitFullscreen) {
    document.exitFullscreen();
  } else if (document.mozCancelFullScreen) { /* Firefox */
    document.mozCancelFullScreen();
  } else if (document.webkitExitFullscreen) { /* Chrome, Safari and Opera */
    document.webkitExitFullscreen();
  } else if (document.msExitFullscreen) { /* IE/Edge */
    document.msExitFullscreen();
  }
  document.getElementById("btn_toggle_fullscreen").style.display = "inline-block";
  document.getElementById("btn_play_music").style.display = "inline-block";
}
</script>
</head>

<body onload="bdyonload();return true;">
  <div class="container">
    <div class="setting-btn">
      <button id="btn_play_music" onclick="playMusik();return true;">
        <i id="audio_toggle" class="large material-icons" style="font-size:18px">volume_off</i>
      </button>
      <button id="btn_toggle_fullscreen" onclick="openFullscreen(document.documentElement);return true;">
        <i id="fullscreen_toggle" class="large material-icons" style="font-size:18px">fullscreen</i>
      </button>
    </div>
    <div class="content">
      <p id="output" class="output"></p>
      <div class="input">
        {%- if appearance.input-bar-settings.topline -%}<hr>{%- endif -%}
        <span style="margin-left: 0.5rem;">{{appearance.input-bar-settings.symbol}}
          <input type="text" id="input" style="display:inline-block" placeholder='type command here...'/>
        </span>
      </div>
    </div>
  </div>
</body>
